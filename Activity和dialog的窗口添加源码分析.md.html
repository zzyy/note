<!DOCTYPE html>
<html>
  <head>
      <meta charset="utf-8" />
      <title>Activity和dialog的窗口添加源码分析</title>
      <style>.markdown-preview:not([data-use-github-style]) { padding: 2em; font-size: 1.2em; color: rgb(186, 190, 189); overflow: auto; background-color: rgb(14, 17, 18); }
.markdown-preview:not([data-use-github-style]) > :first-child { margin-top: 0px; }
.markdown-preview:not([data-use-github-style]) h1, .markdown-preview:not([data-use-github-style]) h2, .markdown-preview:not([data-use-github-style]) h3, .markdown-preview:not([data-use-github-style]) h4, .markdown-preview:not([data-use-github-style]) h5, .markdown-preview:not([data-use-github-style]) h6 { line-height: 1.2; margin-top: 1.5em; margin-bottom: 0.5em; color: rgb(255, 255, 255); }
.markdown-preview:not([data-use-github-style]) h1 { font-size: 2.4em; font-weight: 300; }
.markdown-preview:not([data-use-github-style]) h2 { font-size: 1.8em; font-weight: 400; }
.markdown-preview:not([data-use-github-style]) h3 { font-size: 1.5em; font-weight: 500; }
.markdown-preview:not([data-use-github-style]) h4 { font-size: 1.2em; font-weight: 600; }
.markdown-preview:not([data-use-github-style]) h5 { font-size: 1.1em; font-weight: 600; }
.markdown-preview:not([data-use-github-style]) h6 { font-size: 1em; font-weight: 600; }
.markdown-preview:not([data-use-github-style]) strong { color: rgb(255, 255, 255); }
.markdown-preview:not([data-use-github-style]) del { color: rgb(143, 151, 148); }
.markdown-preview:not([data-use-github-style]) a, .markdown-preview:not([data-use-github-style]) a code { color: rgb(186, 190, 189); }
.markdown-preview:not([data-use-github-style]) img { max-width: 100%; }
.markdown-preview:not([data-use-github-style]) > p { margin-top: 0px; margin-bottom: 1.5em; }
.markdown-preview:not([data-use-github-style]) > ul, .markdown-preview:not([data-use-github-style]) > ol { margin-bottom: 1.5em; }
.markdown-preview:not([data-use-github-style]) blockquote { margin: 1.5em 0px; font-size: inherit; color: rgb(143, 151, 148); border-color: rgb(50, 60, 64); border-width: 4px; }
.markdown-preview:not([data-use-github-style]) hr { margin: 3em 0px; border-top-width: 2px; border-top-style: dashed; border-top-color: rgb(50, 60, 64); background: none; }
.markdown-preview:not([data-use-github-style]) table { margin: 1.5em 0px; }
.markdown-preview:not([data-use-github-style]) th { color: rgb(255, 255, 255); }
.markdown-preview:not([data-use-github-style]) th, .markdown-preview:not([data-use-github-style]) td { padding: 0.66em 1em; border: 1px solid rgb(50, 60, 64); }
.markdown-preview:not([data-use-github-style]) code { color: rgb(255, 255, 255); background-color: rgb(32, 39, 41); }
.markdown-preview:not([data-use-github-style]) pre.editor-colors { margin: 1.5em 0px; padding: 1em; font-size: 0.92em; border-radius: 3px; background-color: rgb(23, 28, 29); }
.markdown-preview:not([data-use-github-style]) kbd { color: rgb(255, 255, 255); border-width: 1px 1px 2px; border-style: solid; border-color: rgb(50, 60, 64) rgb(50, 60, 64) rgb(36, 44, 47); background-color: rgb(32, 39, 41); }
.markdown-preview[data-use-github-style] { font-family: 'Helvetica Neue', Helvetica, 'Segoe UI', Arial, freesans, sans-serif; line-height: 1.6; word-wrap: break-word; padding: 30px; font-size: 16px; color: rgb(51, 51, 51); overflow: scroll; background-color: rgb(255, 255, 255); }
.markdown-preview[data-use-github-style] > :first-child { margin-top: 0px !important; }
.markdown-preview[data-use-github-style] > :last-child { margin-bottom: 0px !important; }
.markdown-preview[data-use-github-style] a:not([href]) { color: inherit; text-decoration: none; }
.markdown-preview[data-use-github-style] .absent { color: rgb(204, 0, 0); }
.markdown-preview[data-use-github-style] .anchor { position: absolute; top: 0px; left: 0px; display: block; padding-right: 6px; padding-left: 30px; margin-left: -30px; }
.markdown-preview[data-use-github-style] .anchor:focus { outline: none; }
.markdown-preview[data-use-github-style] h1, .markdown-preview[data-use-github-style] h2, .markdown-preview[data-use-github-style] h3, .markdown-preview[data-use-github-style] h4, .markdown-preview[data-use-github-style] h5, .markdown-preview[data-use-github-style] h6 { position: relative; margin-top: 1em; margin-bottom: 16px; font-weight: bold; line-height: 1.4; }
.markdown-preview[data-use-github-style] h1 .octicon-link, .markdown-preview[data-use-github-style] h2 .octicon-link, .markdown-preview[data-use-github-style] h3 .octicon-link, .markdown-preview[data-use-github-style] h4 .octicon-link, .markdown-preview[data-use-github-style] h5 .octicon-link, .markdown-preview[data-use-github-style] h6 .octicon-link { display: none; color: rgb(0, 0, 0); vertical-align: middle; }
.markdown-preview[data-use-github-style] h1:hover .anchor, .markdown-preview[data-use-github-style] h2:hover .anchor, .markdown-preview[data-use-github-style] h3:hover .anchor, .markdown-preview[data-use-github-style] h4:hover .anchor, .markdown-preview[data-use-github-style] h5:hover .anchor, .markdown-preview[data-use-github-style] h6:hover .anchor { padding-left: 8px; margin-left: -30px; text-decoration: none; }
.markdown-preview[data-use-github-style] h1:hover .anchor .octicon-link, .markdown-preview[data-use-github-style] h2:hover .anchor .octicon-link, .markdown-preview[data-use-github-style] h3:hover .anchor .octicon-link, .markdown-preview[data-use-github-style] h4:hover .anchor .octicon-link, .markdown-preview[data-use-github-style] h5:hover .anchor .octicon-link, .markdown-preview[data-use-github-style] h6:hover .anchor .octicon-link { display: inline-block; }
.markdown-preview[data-use-github-style] h1 tt, .markdown-preview[data-use-github-style] h2 tt, .markdown-preview[data-use-github-style] h3 tt, .markdown-preview[data-use-github-style] h4 tt, .markdown-preview[data-use-github-style] h5 tt, .markdown-preview[data-use-github-style] h6 tt, .markdown-preview[data-use-github-style] h1 code, .markdown-preview[data-use-github-style] h2 code, .markdown-preview[data-use-github-style] h3 code, .markdown-preview[data-use-github-style] h4 code, .markdown-preview[data-use-github-style] h5 code, .markdown-preview[data-use-github-style] h6 code { font-size: inherit; }
.markdown-preview[data-use-github-style] h1 { padding-bottom: 0.3em; font-size: 2.25em; line-height: 1.2; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(238, 238, 238); }
.markdown-preview[data-use-github-style] h1 .anchor { line-height: 1; }
.markdown-preview[data-use-github-style] h2 { padding-bottom: 0.3em; font-size: 1.75em; line-height: 1.225; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(238, 238, 238); }
.markdown-preview[data-use-github-style] h2 .anchor { line-height: 1; }
.markdown-preview[data-use-github-style] h3 { font-size: 1.5em; line-height: 1.43; }
.markdown-preview[data-use-github-style] h3 .anchor { line-height: 1.2; }
.markdown-preview[data-use-github-style] h4 { font-size: 1.25em; }
.markdown-preview[data-use-github-style] h4 .anchor { line-height: 1.2; }
.markdown-preview[data-use-github-style] h5 { font-size: 1em; }
.markdown-preview[data-use-github-style] h5 .anchor { line-height: 1.1; }
.markdown-preview[data-use-github-style] h6 { font-size: 1em; color: rgb(119, 119, 119); }
.markdown-preview[data-use-github-style] h6 .anchor { line-height: 1.1; }
.markdown-preview[data-use-github-style] p, .markdown-preview[data-use-github-style] blockquote, .markdown-preview[data-use-github-style] ul, .markdown-preview[data-use-github-style] ol, .markdown-preview[data-use-github-style] dl, .markdown-preview[data-use-github-style] table, .markdown-preview[data-use-github-style] pre { margin-top: 0px; margin-bottom: 16px; }
.markdown-preview[data-use-github-style] hr { height: 4px; padding: 0px; margin: 16px 0px; border: 0px none; background-color: rgb(231, 231, 231); }
.markdown-preview[data-use-github-style] ul, .markdown-preview[data-use-github-style] ol { padding-left: 2em; }
.markdown-preview[data-use-github-style] ul.no-list, .markdown-preview[data-use-github-style] ol.no-list { padding: 0px; list-style-type: none; }
.markdown-preview[data-use-github-style] ul ul, .markdown-preview[data-use-github-style] ul ol, .markdown-preview[data-use-github-style] ol ol, .markdown-preview[data-use-github-style] ol ul { margin-top: 0px; margin-bottom: 0px; }
.markdown-preview[data-use-github-style] li > p { margin-top: 16px; }
.markdown-preview[data-use-github-style] dl { padding: 0px; }
.markdown-preview[data-use-github-style] dl dt { padding: 0px; margin-top: 16px; font-size: 1em; font-style: italic; font-weight: bold; }
.markdown-preview[data-use-github-style] dl dd { padding: 0px 16px; margin-bottom: 16px; }
.markdown-preview[data-use-github-style] blockquote { padding: 0px 15px; color: rgb(119, 119, 119); border-left-width: 4px; border-left-style: solid; border-left-color: rgb(221, 221, 221); }
.markdown-preview[data-use-github-style] blockquote > :first-child { margin-top: 0px; }
.markdown-preview[data-use-github-style] blockquote > :last-child { margin-bottom: 0px; }
.markdown-preview[data-use-github-style] table { display: block; width: 100%; overflow: auto; word-break: keep-all; }
.markdown-preview[data-use-github-style] table th { font-weight: bold; }
.markdown-preview[data-use-github-style] table th, .markdown-preview[data-use-github-style] table td { padding: 6px 13px; border: 1px solid rgb(221, 221, 221); }
.markdown-preview[data-use-github-style] table tr { border-top-width: 1px; border-top-style: solid; border-top-color: rgb(204, 204, 204); background-color: rgb(255, 255, 255); }
.markdown-preview[data-use-github-style] table tr:nth-child(2n) { background-color: rgb(248, 248, 248); }
.markdown-preview[data-use-github-style] img { max-width: 100%; box-sizing: border-box; }
.markdown-preview[data-use-github-style] .emoji { max-width: none; }
.markdown-preview[data-use-github-style] span.frame { display: block; overflow: hidden; }
.markdown-preview[data-use-github-style] span.frame > span { display: block; float: left; width: auto; padding: 7px; margin: 13px 0px 0px; overflow: hidden; border: 1px solid rgb(221, 221, 221); }
.markdown-preview[data-use-github-style] span.frame span img { display: block; float: left; }
.markdown-preview[data-use-github-style] span.frame span span { display: block; padding: 5px 0px 0px; clear: both; color: rgb(51, 51, 51); }
.markdown-preview[data-use-github-style] span.align-center { display: block; overflow: hidden; clear: both; }
.markdown-preview[data-use-github-style] span.align-center > span { display: block; margin: 13px auto 0px; overflow: hidden; text-align: center; }
.markdown-preview[data-use-github-style] span.align-center span img { margin: 0px auto; text-align: center; }
.markdown-preview[data-use-github-style] span.align-right { display: block; overflow: hidden; clear: both; }
.markdown-preview[data-use-github-style] span.align-right > span { display: block; margin: 13px 0px 0px; overflow: hidden; text-align: right; }
.markdown-preview[data-use-github-style] span.align-right span img { margin: 0px; text-align: right; }
.markdown-preview[data-use-github-style] span.float-left { display: block; float: left; margin-right: 13px; overflow: hidden; }
.markdown-preview[data-use-github-style] span.float-left span { margin: 13px 0px 0px; }
.markdown-preview[data-use-github-style] span.float-right { display: block; float: right; margin-left: 13px; overflow: hidden; }
.markdown-preview[data-use-github-style] span.float-right > span { display: block; margin: 13px auto 0px; overflow: hidden; text-align: right; }
.markdown-preview[data-use-github-style] code, .markdown-preview[data-use-github-style] tt { padding: 0.2em 0px; margin: 0px; font-size: 85%; border-radius: 3px; background-color: rgba(0, 0, 0, 0.0392157); }
.markdown-preview[data-use-github-style] code::before, .markdown-preview[data-use-github-style] tt::before, .markdown-preview[data-use-github-style] code::after, .markdown-preview[data-use-github-style] tt::after { letter-spacing: -0.2em; content: " "; }
.markdown-preview[data-use-github-style] code br, .markdown-preview[data-use-github-style] tt br { display: none; }
.markdown-preview[data-use-github-style] del code { text-decoration: inherit; }
.markdown-preview[data-use-github-style] pre > code { padding: 0px; margin: 0px; font-size: 100%; word-break: normal; white-space: pre; border: 0px; background: transparent; }
.markdown-preview[data-use-github-style] .highlight { margin-bottom: 16px; }
.markdown-preview[data-use-github-style] .highlight pre, .markdown-preview[data-use-github-style] pre { padding: 16px; overflow: auto; font-size: 85%; line-height: 1.45; border-radius: 3px; background-color: rgb(247, 247, 247); }
.markdown-preview[data-use-github-style] .highlight pre { margin-bottom: 0px; word-break: normal; }
.markdown-preview[data-use-github-style] pre { word-wrap: normal; }
.markdown-preview[data-use-github-style] pre code, .markdown-preview[data-use-github-style] pre tt { display: inline; max-width: initial; padding: 0px; margin: 0px; overflow: initial; line-height: inherit; word-wrap: normal; border: 0px; background-color: transparent; }
.markdown-preview[data-use-github-style] pre code::before, .markdown-preview[data-use-github-style] pre tt::before, .markdown-preview[data-use-github-style] pre code::after, .markdown-preview[data-use-github-style] pre tt::after { content: normal; }
.markdown-preview[data-use-github-style] kbd { display: inline-block; padding: 3px 5px; font-size: 11px; line-height: 10px; color: rgb(85, 85, 85); vertical-align: middle; border-style: solid; border-width: 1px; border-color: rgb(204, 204, 204) rgb(204, 204, 204) rgb(187, 187, 187); border-radius: 3px; box-shadow: rgb(187, 187, 187) 0px -1px 0px inset; background-color: rgb(252, 252, 252); }
.markdown-preview[data-use-github-style] a { color: rgb(51, 122, 183); }
.markdown-preview[data-use-github-style] code { color: inherit; }
.markdown-preview[data-use-github-style] pre.editor-colors { padding: 0.8em 1em; margin-bottom: 1em; font-size: 0.85em; border-radius: 4px; overflow: auto; }
.scrollbars-visible-always .markdown-preview pre.editor-colors::shadow .vertical-scrollbar, .scrollbars-visible-always .markdown-preview pre.editor-colors::shadow .horizontal-scrollbar { visibility: hidden; }
.scrollbars-visible-always .markdown-preview pre.editor-colors:hover::shadow .vertical-scrollbar, .scrollbars-visible-always .markdown-preview pre.editor-colors:hover::shadow .horizontal-scrollbar { visibility: visible; }
.bracket-matcher .region {
  border-bottom: 1px dotted lime;
  position: absolute;
}

.spell-check-misspelling .region {
  border-bottom: 2px dotted rgba(255, 51, 51, 0.75);
}

.pre.editor-colors,
.host {
  background-color: #0e1112;
  color: #babebd;
}
.pre.editor-colors,
.host {
  background-color: #0e1112;
  color: #babebd;
}
.pre.editor-colors .wrap-guide,
.host .wrap-guide {
  background: rgba(245, 250, 255, 0.04);
}
.pre.editor-colors .indent-guide,
.host .indent-guide {
  color: rgba(245, 250, 255, 0.04);
}
.pre.editor-colors .invisible-character,
.host .invisible-character {
  color: rgba(255, 255, 255, 0.1);
}
.pre.editor-colors .gutter,
.host .gutter {
  background-color: #090b0d;
  color: #4d5a5e;
}
.pre.editor-colors .gutter .line-number,
.host .gutter .line-number {
  background: #090b0d;
  color: #4d5a5e;
  padding-left: 10px;
}
.pre.editor-colors .gutter .line-number.cursor-line,
.host .gutter .line-number.cursor-line {
  background-color: #0e1112;
  color: #519aba;
  font-weight: 100;
}
.pre.editor-colors .gutter .line-number.cursor-line-no-selection,
.host .gutter .line-number.cursor-line-no-selection {
  background-color: #0e1112 !important;
  color: #519aba;
}
.pre.editor-colors .gutter .line-number:hover,
.host .gutter .line-number:hover {
  background-color: #090b0d !important;
  color: #519aba;
}
.pre.editor-colors .gutter .line-number.folded,
.host .gutter .line-number.folded,
.pre.editor-colors .gutter .line-number:after,
.host .gutter .line-number:after,
.pre.editor-colors .fold-marker:after,
.host .fold-marker:after {
  color: #FFF;
  background: #4d5a5e;
}
.pre.editor-colors .invisible,
.host .invisible {
  color: rgba(255, 255, 255, 0.1);
}
.pre.editor-colors .cursor,
.host .cursor {
  border-color: #babebd !important;
  border-left: solid 2px;
}
.pre.editor-colors .selection .region,
.host .selection .region {
  background-color: #1d5b91;
}
.pre.editor-colors .scroll-view,
.host .scroll-view {
  padding-left: 10px;
}
.pre.editor-colors .line.cursor-line,
.host .line.cursor-line {
  background: rgba(0, 0, 0, 0.2) !important;
}
.bracket-matcher .region {
  border-bottom: 1px solid #519aba;
  margin-top: 2px;
}
pre.editor-colors[mini] .scroll-view,
.host(.mini) .scroll-view {
  padding-left: 1px;
}
.text {
  color: #babebd;
}
.complete_tag {
  color: #7494a3;
}
.comment {
  color: #4d5a5e;
  background: none;
}
.constant {
  color: #a074c4;
}
.constant.character.escape {
  color: #a074c4;
}
.constant.name.attribute.tag {
  color: #519aba;
}
.constant.numeric {
  color: #a074c4;
}
.constant.other.color {
  color: #a074c4;
}
.constant.other.symbol {
  color: #a074c4;
}
.entity {
  color: #cbcb41;
}
.entity.name.class,
.entity.name.type.class {
  color: #a074c4;
}
.entity.name.function {
  color: #cbcb41;
}
.entity.name.section {
  color: #cbcb41;
}
.entity.name.tag {
  color: #519aba;
  text-decoration: none;
}
.entity.name.tag.block,
.entity.name.tag.inline,
.entity.name.tag.name {
  color: #519aba;
}
.entity.name.tag.structure {
  color: #519aba;
}
.entity.name.tag.block {
  color: #519aba;
}
.entity.name.type {
  color: #519aba;
  text-decoration: none;
}
.entity.name.type.tag {
  color: #8dc149;
}
.entity.other.attribute-name {
  color: #8dc149;
}
.entity.other.attribute-name.id {
  color: #8dc149;
}
.entity.other.inherited-class {
  color: #cbcb41;
}
.invalid.illegal,
.invalid.deprecated {
  background: none;
  color: #cc3e44;
}
.keyword {
  color: #cc3e44;
}
.keyword.control {
  color: #8dc149;
}
.keyword.operator {
  color: #cc3e44;
}
.keyword.operator.assignment {
  color: #4d5a5e;
}
.keyword.operator.new {
  color: #7494a3;
}
.keyword.other.important {
  color: #cc3e44;
}
.keyword.other.special-method {
  color: #cc3e44;
}
.keyword.other.unit {
  color: #cc3e44;
}
.markup.bold {
  color: #babebd;
  font-weight: bold;
}
.markup.changed {
  color: #babebd;
}
.markup.deleted {
  color: #babebd;
}
.markup.heading .punctuation.definition.heading {
  color: #babebd;
}
.markup.inserted {
  color: #babebd;
}
.markup.italic {
  color: #babebd;
  font-style: italic;
}
.markup.list {
  color: #babebd;
}
.markup.quote {
  color: #9ac4d7;
}
.markup.raw.inline {
  color: #babebd;
}
.meta.link {
  color: #babebd;
}
.meta.require {
  color: #babebd;
}
.meta.brace.curly {
  color: #6b7471;
}
.meta.brace.round {
  color: #babebd;
}
.meta.control.flow {
  color: #8dc149;
}
.meta.comma {
  color: #4d5a5e;
}
.meta.selector {
  color: #4d5a5e;
}
.meta.separator {
  background-color: #4d5a5e;
  color: #4d5a5e;
}
.meta.tag {
  color: #519aba;
}
.none {
  color: #babebd;
}
.punctuation {
  color: #4d5a5e;
}
.punctuation.terminator {
  color: #4d5a5e;
}
.punctuation.separator {
  color: #4d5a5e;
}
.punctuation.definition {
  color: #4d5a5e;
}
.punctuation.definition.array {
  color: #519aba;
}
.punctuation.definition.bold {
  color: #babebd;
  font-weight: bold;
}
.punctuation.definition.comment {
  color: #4d5a5e;
}
.punctuation.definition.heading,
.punctuation.definition.identity,
.punctuation.definition.italic {
  color: #babebd;
}
.punctuation.definition.italic {
  font-style: italic;
}
.punctuation.definition.string {
  color: #519aba;
}
.punctuation.definition.string.begin,
.punctuation.definition.string.end {
  color: #9ac4d7;
}
.punctuation.definition.variable {
  color: #7494a3;
}
.punctuation.definition.parameters {
  color: #babebd;
}
.punctuation.definition.tag {
  color: #519aba;
}
.punctuation.section.embedded {
  color: #babebd;
}
.string {
  color: #519aba;
}
.string .constant {
  color: #a074c4;
}
.string.interpolated {
  color: #7494a3;
}
.string.regexp {
  color: #519aba;
}
.string.regexp .constant.character.escape,
.string.regexp .source.ruby.embedded,
.string.regexp .string.regexp.arbitrary-repitition {
  color: #519aba;
}
.string.regexp.group {
  color: #519aba;
}
.string.regexp.character-class {
  color: #519aba;
}
.string.regexp .source.ruby.embedded {
  color: #519aba;
}
.string.quoted.double {
  color: #9ac4d7;
}
.string.quoted.single {
  color: #9ac4d7;
}
.string .variable {
  color: #7494a3;
}
.string.other.link {
  color: #519aba;
}
.source {
  color: #519aba;
}
.storage {
  color: #d4d7d6;
}
.storage.modifier {
  color: #d4d7d6;
}
.storage.type.class {
  color: #d4d7d6;
}
.storage.type.function {
  color: #d4d7d6;
}
.storage.type.var {
  color: #d4d7d6;
}
.support {
  color: #a074c4;
}
.support.class {
  color: #a074c4;
}
.support.function {
  color: #cbcb41;
}
.support.function.decl {
  color: #519aba;
}
.support.constant {
  color: #a074c4;
}
.support.type.property-name {
  color: #babebd;
}
.variable {
  color: #7494a3;
}
.variable.control.import.include {
  color: #8dc149;
}
.variable.other {
  color: #cc3e44;
}
.variable.other.property {
  color: #cc3e44;
}
.variable.other.module {
  color: #a074c4;
}
.variable.other.module-alias {
  color: #519aba;
}
.variable.other.object {
  color: #8dc149;
}
.variable.parameter.function {
  color: #cbcb41;
}
.source.json .meta.structure.dictionary.json > .string.quoted.json {
  color: #519aba;
}
.source.json .meta.structure.dictionary.json > .string.quoted.json > .punctuation.string {
  color: #519aba;
}
.source.json .meta.structure.dictionary.json > .value.json > .string.quoted.json,
.source.json .meta.structure.array.json > .value.json > .string.quoted.json,
.source.json .meta.structure.dictionary.json > .value.json > .string.quoted.json > .punctuation,
.source.json .meta.structure.array.json > .value.json > .string.quoted.json > .punctuation {
  color: #babebd;
}
.source.json .meta.structure.dictionary.json > .constant.language.json,
.source.json .meta.structure.array.json > .constant.language.json {
  color: #a074c4;
}
.mustache .meta.tag.template {
  color: #519aba;
}
.mustache .meta.tag.template .entity.name.tag {
  color: #9ac4d7;
}
.source.python .class {
  color: #a074c4;
}
.source.python .support.function.magic,
.source.python .inherited-class {
  color: #93acb7;
}
.source.python .support.function.magic .support.function.builtin.python,
.source.python .inherited-class .support.function.builtin.python {
  color: #93acb7;
}
.source.python .storage,
.source.python .keyword {
  color: #d4d7d6;
}
.source.python .string {
  color: #519aba;
}
.source.python .string.block {
  color: #2f6076;
}
.source.python .string.block .keyword {
  color: #2f6076;
}
pre.editor-colors .line.split-diff-added,
pre.editor-colors::shadow .line.split-diff-added {
  background: #8dc149 !important;
  color: rgba(0, 0, 0, 0.5) !important;
}
pre.editor-colors .line.split-diff-added .text span,
pre.editor-colors::shadow .line.split-diff-added .text span,
pre.editor-colors .line.split-diff-added .source span,
pre.editor-colors::shadow .line.split-diff-added .source span {
  color: rgba(0, 0, 0, 0.5) !important;
}
pre.editor-colors .line.split-diff-added .indent-guide,
pre.editor-colors::shadow .line.split-diff-added .indent-guide {
  opacity: 0;
}
pre.editor-colors .line.split-diff-removed,
pre.editor-colors::shadow .line.split-diff-removed {
  background: #cc3e44 !important;
  color: rgba(255, 255, 255, 0.8) !important;
}
pre.editor-colors .line.split-diff-removed .text span,
pre.editor-colors::shadow .line.split-diff-removed .text span,
pre.editor-colors .line.split-diff-removed .source span,
pre.editor-colors::shadow .line.split-diff-removed .source span {
  color: rgba(255, 255, 255, 0.8) !important;
}
pre.editor-colors .line.split-diff-removed .indent-guide,
pre.editor-colors::shadow .line.split-diff-removed .indent-guide {
  opacity: 0;
}
</style>
  </head>
  <body class='markdown-preview' data-use-github-style><p>本文是最近看Window有关源码的部分记录和分析, 可能有差错; 另有很多代码,比较枯燥</p>
<p>先说部分结论</p>
<ol>
<li>Window是一个抽象类, 具体的实现是PhoneWindow</li>
<li>android系统中, 每个界面,对应着一个window; 但其实在android系统中window也是一个抽象的概率,它是以view的形式存在; 在使用中, 无法直接访问Window, 只能通过WindowManager才能访问Window; 每个Window都对应一个View和一个ViewRootImpl, ViewRootImpl是连接Window和WMS的桥梁, WMS的一些消息,通过ViewRootImpl转发给View;</li>
<li>WindowManager继承自ViewManager(间接证明Window其实对应的是View?)，常用的只有三个方法：addView、updateView和removeView</li>
<li>各种Window的不同, 主要是 token及type的不同</li>
<li>app中控制window, 是通过<code>WindowManager.LayoutParams</code>去控制, eg: 通过<code>x</code>,<code>y</code>,<code>gravity</code>去控制位置...</li>
</ol>
<hr>
<h1 id="activity-window-">Activity 的window添加</h1>
<p>Activity创建之后, 在ActivityThread中 调用 Activity#attach, 进行一些初始化操作</p>
<pre class="editor-colors lang-java"><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="storage modifier java"><span>final</span></span><span>&nbsp;</span><span class="storage type primitive java"><span>void</span></span><span>&nbsp;</span><span class="meta function-call java"><span class="entity name function java"><span>attach</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="storage type java"><span>Context</span></span><span>&nbsp;context</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="storage type java"><span>ActivityThread</span></span><span>&nbsp;aThread</span><span class="punctuation separator delimiter java"><span>,</span></span></span></span></div><div class="line"><span class="source java"><span class="meta function-call java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type java"><span>Instrumentation</span></span><span>&nbsp;instr</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="storage type java"><span>IBinder</span></span><span>&nbsp;token</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="storage type primitive java"><span>int</span></span><span>&nbsp;ident</span><span class="punctuation separator delimiter java"><span>,</span></span></span></span></div><div class="line"><span class="source java"><span class="meta function-call java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type java"><span>Application</span></span><span>&nbsp;application</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="storage type java"><span>Intent</span></span><span>&nbsp;intent</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="storage type java"><span>ActivityInfo</span></span><span>&nbsp;info</span><span class="punctuation separator delimiter java"><span>,</span></span></span></span></div><div class="line"><span class="source java"><span class="meta function-call java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type java"><span>CharSequence</span></span><span>&nbsp;title</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="storage type java"><span>Activity</span></span><span>&nbsp;parent</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="storage type java"><span>String</span></span><span>&nbsp;id</span><span class="punctuation separator delimiter java"><span>,</span></span></span></span></div><div class="line"><span class="source java"><span class="meta function-call java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type java"><span>NonConfigurationInstances</span></span><span>&nbsp;lastNonConfigurationInstances</span><span class="punctuation separator delimiter java"><span>,</span></span></span></span></div><div class="line"><span class="source java"><span class="meta function-call java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type java"><span>Configuration</span></span><span>&nbsp;config</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="storage type java"><span>String</span></span><span>&nbsp;referrer</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="storage type java"><span>IVoiceInteractor</span></span><span>&nbsp;voiceInteractor</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta function-call java"><span class="entity name function java"><span>attachBaseContext</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span>context</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span><span>.</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>创建对应的Window&nbsp;并设置callback,&nbsp;其实为PhoneWindow</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mWindow&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="keyword control new java"><span>new</span></span><span>&nbsp;</span><span class="storage type java"><span>PhoneWindow</span></span><span class="punctuation bracket round java"><span>(</span></span><span class="variable language this java"><span>this</span></span><span class="punctuation bracket round java"><span>)</span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>mWindow</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>setCallback</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="variable language this java"><span>this</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>mWindow</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>setOnWindowDismissedCallback</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="variable language this java"><span>this</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span><span>.</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;设置Window的WindowManager,&nbsp;对Window的mWindowManager赋值,</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;事实上,&nbsp;Window中&nbsp;并未使用传递进去的windowManager,&nbsp;而是在此方法中&nbsp;调用WindowManagerImpl.createLocalWindowManager&nbsp;重新创建了一个</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>mWindow</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>setWindowManager</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span></span></span></div><div class="line"><span class="source java"><span class="meta method-call java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation bracket round java"><span>(</span></span><span class="storage type java"><span>WindowManager</span></span><span class="punctuation bracket round java"><span>)</span></span><span class="variable other object java"><span>context</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>getSystemService</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="variable other object java"><span>Context</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>WINDOW_SERVICE</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation separator delimiter java"><span>,</span></span></span></span></div><div class="line"><span class="source java"><span class="meta method-call java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mToken</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="variable other object java"><span>mComponent</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>flattenToString</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation separator delimiter java"><span>,</span></span></span></span></div><div class="line"><span class="source java"><span class="meta method-call java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation bracket round java"><span>(</span></span><span class="variable other object java"><span>info</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>flags</span></span><span>&nbsp;</span><span class="keyword operator bitwise java"><span>&amp;</span></span><span>&nbsp;</span><span class="variable other object java"><span>ActivityInfo</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>FLAG_HARDWARE_ACCELERATED</span></span><span class="punctuation bracket round java"><span>)</span></span><span>&nbsp;</span><span class="keyword operator comparison java"><span>!=</span></span><span>&nbsp;</span><span class="constant numeric java"><span>0</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>if</span></span><span>&nbsp;</span><span class="punctuation bracket round java"><span>(</span></span><span>mParent&nbsp;</span><span class="keyword operator comparison java"><span>!=</span></span><span>&nbsp;</span><span class="constant language java"><span>null</span></span><span class="punctuation bracket round java"><span>)</span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>mWindow</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>setContainer</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="variable other object java"><span>mParent</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>getWindow</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;把window对象中的&nbsp;windowManager&nbsp;关联到&nbsp;Activity的&nbsp;mWindowManager</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mWindowManager&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="variable other object java"><span>mWindow</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>getWindowManager</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div></pre>
<p>在Activity#attach中, 可以看出创建了一个PhoneWindow对象, 并且通过<code>context.getSystemService(Context.WINDOW_SERVICE)</code>设置了WindowManager对象, 还通过Window#getWindowManager对Activity的mWindowManager赋值, 这样 Activity的Window WindowManager就关联起来了;</p>
<p>接着看上面代码,里面会通过context.getSystemService(Context.WINDOW_SERVICE)拿到一个windowManager对象, 这个window对象是什么呢? 如果对Context有过研究的话, 可以知道Context的实际对象是ContetImpl, 其中所有通过 getSystemService返回的对象, 都是通过static的代码块静态添加的, 只需找WINDOW_SERVICE注册的地方(在6.0中 注册的代码 已经提取到&#39;android.app.SystemServiceRegistry#registerService&#39;中了)</p>
<pre class="editor-colors lang-java"><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="meta function-call java"><span class="entity name function java"><span>registerService</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="variable other object java"><span>Context</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>WINDOW_SERVICE</span></span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="variable other object java"><span>WindowManager</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>class</span></span><span class="punctuation separator delimiter java"><span>,</span></span></span></span></div><div class="line"><span class="source java"><span class="meta function-call java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control new java"><span>new</span></span><span>&nbsp;</span><span class="storage type java"><span>CachedServiceFetcher</span></span><span class="punctuation bracket angle java"><span>&lt;</span></span><span class="storage type generic java"><span>WindowManager</span></span><span class="punctuation bracket angle java"><span>&gt;</span></span><span class="punctuation bracket round java"><span>(</span><span>)</span></span><span>&nbsp;</span><span class="meta inner-class java"><span class="punctuation section inner-class begin bracket curly java"><span>{</span></span></span></span></span></div><div class="line"><span class="source java"><span class="meta function-call java"><span class="meta inner-class java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type annotation java"><span>@Override</span></span></span></span></span></div><div class="line"><span class="source java"><span class="meta function-call java"><span class="meta inner-class java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta method java"><span class="storage modifier java"><span>public</span></span><span>&nbsp;</span><span class="meta method return-type java"><span class="storage type java"><span>WindowManager</span></span></span><span>&nbsp;</span><span class="meta method identifier java"><span class="entity name function java"><span>createService</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="storage type java"><span>ContextImpl</span></span><span>&nbsp;</span><span class="variable parameter java"><span>ctx</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span>&nbsp;</span><span class="punctuation section method begin bracket curly java"><span>{</span></span></span></span></span></span></div><div class="line"><span class="source java"><span class="meta function-call java"><span class="meta inner-class java"><span class="meta method java"><span class="meta method body java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>return</span></span><span>&nbsp;</span><span class="keyword control new java"><span>new</span></span><span>&nbsp;</span><span class="storage type java"><span>WindowManagerImpl</span></span><span class="punctuation bracket round java"><span>(</span></span><span class="variable other object java"><span>ctx</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>getDisplay</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation bracket round java"><span>)</span></span><span class="punctuation terminator java"><span>;</span></span></span></span></span></span></span></div><div class="line"><span class="source java"><span class="meta function-call java"><span class="meta inner-class java"><span class="meta method java"><span class="meta method body java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="punctuation section method end bracket curly java"><span>}</span></span></span><span class="punctuation section inner-class end bracket curly java"><span>}</span></span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div></pre>
<p>可以看见,实际的对象是WindowManagerImpl; (另外 Activity本身重写了getSystemService方法,如果使用android.app.Activity#getSystemService, 返回的其实不是这个对象, 下面会说到);</p>
<p>上面注释说到, android.view.Window#setWindowManager中, 并未使用传递进去的WindowManager,而创建了一个新对象, 可以看一下代码</p>
<pre class="editor-colors lang-java"><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="storage modifier java"><span>public</span></span><span>&nbsp;</span><span class="storage type primitive java"><span>void</span></span><span>&nbsp;</span><span class="meta function-call java"><span class="entity name function java"><span>setWindowManager</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="storage type java"><span>WindowManager</span></span><span>&nbsp;wm</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="storage type java"><span>IBinder</span></span><span>&nbsp;appToken</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="storage type java"><span>String</span></span><span>&nbsp;appName</span><span class="punctuation separator delimiter java"><span>,</span></span></span></span></div><div class="line"><span class="source java"><span class="meta function-call java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type primitive java"><span>boolean</span></span><span>&nbsp;hardwareAccelerated</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;activity把token传进来,&nbsp;保存在Window.mAppToken</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mAppToken&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;appToken</span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mAppName&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;appName</span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mHardwareAccelerated&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;hardwareAccelerated</span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword operator logical java"><span>||</span></span><span>&nbsp;</span><span class="variable other object java"><span>SystemProperties</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>getBoolean</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="storage type java"><span>PROPERTY_HARDWARE_UI</span></span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="constant language java"><span>false</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>if</span></span><span>&nbsp;</span><span class="punctuation bracket round java"><span>(</span></span><span>wm&nbsp;</span><span class="keyword operator comparison java"><span>==</span></span><span>&nbsp;</span><span class="constant language java"><span>null</span></span><span class="punctuation bracket round java"><span>)</span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wm&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="punctuation bracket round java"><span>(</span></span><span class="storage type java"><span>WindowManager</span></span><span class="punctuation bracket round java"><span>)</span></span><span class="variable other object java"><span>mContext</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>getSystemService</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="variable other object java"><span>Context</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>WINDOW_SERVICE</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>创建了一个新的WindowManager,&nbsp;并且把this&nbsp;传递给了WindowManager</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mWindowManager&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="punctuation bracket round java"><span>(</span><span>(</span></span><span class="storage type java"><span>WindowManagerImpl</span></span><span class="punctuation bracket round java"><span>)</span></span><span>wm</span><span class="punctuation bracket round java"><span>)</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>createLocalWindowManager</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="variable language this java"><span>this</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div></pre>
<p>而在android.view.WindowManagerImpl#createLocalWindowManager中, 可以明显看出</p>
<pre class="editor-colors lang-java"><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;Context.getSystemService&nbsp;获得的WindowManager实例,&nbsp;是没有parentWindow的</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="storage modifier java"><span>public</span></span><span>&nbsp;</span><span class="meta function-call java"><span class="entity name function java"><span>WindowManagerImpl</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="storage type java"><span>Display</span></span><span>&nbsp;display</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable language this java"><span>this</span></span><span class="punctuation bracket round java"><span>(</span></span><span>display</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="constant language java"><span>null</span></span><span class="punctuation bracket round java"><span>)</span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;</span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="storage modifier java"><span>private</span></span><span>&nbsp;</span><span class="meta function-call java"><span class="entity name function java"><span>WindowManagerImpl</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="storage type java"><span>Display</span></span><span>&nbsp;display</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="storage type java"><span>Window</span></span><span>&nbsp;parentWindow</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mDisplay&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;display</span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mParentWindow&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;parentWindow</span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;</span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="storage modifier java"><span>public</span></span><span>&nbsp;</span><span class="storage type java"><span>WindowManagerImpl</span></span><span>&nbsp;</span><span class="meta function-call java"><span class="entity name function java"><span>createLocalWindowManager</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="storage type java"><span>Window</span></span><span>&nbsp;parentWindow</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;将传递的&nbsp;window对象保存,&nbsp;对于activity来说,会将PhoneWindow对应的对象传入,&nbsp;而对于&nbsp;Context.getSystemService&nbsp;获得的WindowManager实例,&nbsp;是没有parentWindow的</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>return</span></span><span>&nbsp;</span><span class="keyword control new java"><span>new</span></span><span>&nbsp;</span><span class="storage type java"><span>WindowManagerImpl</span></span><span class="punctuation bracket round java"><span>(</span></span><span>mDisplay</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;parentWindow</span><span class="punctuation bracket round java"><span>)</span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div></pre>
<p>window时我们看见的窗口,接下来看在Activity的window是怎么显示出来, 看<code>Activity.makeVisiable</code></p>
<pre class="editor-colors lang-java"><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="storage type primitive java"><span>void</span></span><span>&nbsp;</span><span class="meta function-call java"><span class="entity name function java"><span>makeVisible</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>if</span></span><span>&nbsp;</span><span class="punctuation bracket round java"><span>(</span></span><span class="keyword operator logical java"><span>!</span></span><span>mWindowAdded</span><span class="punctuation bracket round java"><span>)</span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type java"><span>ViewManager</span></span><span>&nbsp;wm&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="meta function-call java"><span class="entity name function java"><span>getWindowManager</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;windowManger中&nbsp;添加window的根view(&nbsp;即&nbsp;decorView)</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>wm</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>addView</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span>mDecor</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="meta function-call java"><span class="entity name function java"><span>getWindow</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>getAttributes</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mWindowAdded&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="constant language java"><span>true</span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>mDecor</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>setVisibility</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="variable other object java"><span>View</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>VISIBLE</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div></pre>
<p>上面已经说过, WindowManager对应的实例是WindowManagerImpl, 接着看android.view.WindowManagerImpl#addView</p>
<pre class="editor-colors lang-java"><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="storage modifier java"><span>private</span></span><span>&nbsp;</span><span class="storage modifier java"><span>final</span></span><span>&nbsp;</span><span class="storage type java"><span>WindowManagerGlobal</span></span><span>&nbsp;mGlobal&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="variable other object java"><span>WindowManagerGlobal</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>getInstance</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;</span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="storage type annotation java"><span>@Override</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="storage modifier java"><span>public</span></span><span>&nbsp;</span><span class="storage type primitive java"><span>void</span></span><span>&nbsp;</span><span class="meta function-call java"><span class="entity name function java"><span>addView</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="storage type annotation java"><span>@NonNull</span></span><span>&nbsp;</span><span class="storage type java"><span>View</span></span><span>&nbsp;view</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="storage type annotation java"><span>@NonNull</span></span><span>&nbsp;</span><span class="variable other object java"><span>ViewGroup</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>LayoutParams</span></span><span>&nbsp;params</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta function-call java"><span class="entity name function java"><span>applyDefaultToken</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span>params</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>mGlobal</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>addView</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span>view</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;params</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;mDisplay</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;mParentWindow</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div></pre>
<p>代码很简单, 最后调用的是 WindowManagerGlobal#addView, 并且WindowManagerGlobal是一个单例, 看下android.view.WindowManagerGlobal#addView的代码</p>
<pre class="editor-colors lang-java"><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="storage modifier java"><span>public</span></span><span>&nbsp;</span><span class="storage type primitive java"><span>void</span></span><span>&nbsp;</span><span class="meta function-call java"><span class="entity name function java"><span>addView</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="storage type java"><span>View</span></span><span>&nbsp;view</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="variable other object java"><span>ViewGroup</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>LayoutParams</span></span><span>&nbsp;params</span><span class="punctuation separator delimiter java"><span>,</span></span></span></span></div><div class="line"><span class="source java"><span class="meta function-call java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type java"><span>Display</span></span><span>&nbsp;display</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="storage type java"><span>Window</span></span><span>&nbsp;parentWindow</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;首先获得&nbsp;layoutParams</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier java"><span>final</span></span><span>&nbsp;</span><span class="variable other object java"><span>WindowManager</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>LayoutParams</span></span><span>&nbsp;wparams&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="punctuation bracket round java"><span>(</span></span><span class="variable other object java"><span>WindowManager</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>LayoutParams</span></span><span class="punctuation bracket round java"><span>)</span></span><span>&nbsp;params</span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>if</span></span><span>&nbsp;</span><span class="punctuation bracket round java"><span>(</span></span><span>parentWindow&nbsp;</span><span class="keyword operator comparison java"><span>!=</span></span><span>&nbsp;</span><span class="constant language java"><span>null</span></span><span class="punctuation bracket round java"><span>)</span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;parentWindow是&nbsp;WindowManagerImpl的成员变量mParentWindow;</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;对于&nbsp;activity来说,&nbsp;即在mWindow.setWindowManager中&nbsp;调用WindowManagerImpl.createLocalWindowManager(Window)去创建&nbsp;mWindowManager实例时,&nbsp;传入的phoneWindow对象</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;调用下面这个方法,&nbsp;会调整&nbsp;WindowManager.LayoutParams,&nbsp;主要是&nbsp;设置&nbsp;token&nbsp;和硬件加速的标志位</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>parentWindow</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>adjustLayoutParamsForSubWindow</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span>wparams</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span><span>&nbsp;</span><span class="keyword control java"><span>else</span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;If&nbsp;there&#39;s&nbsp;no&nbsp;parent,&nbsp;then&nbsp;hardware&nbsp;acceleration&nbsp;for&nbsp;this&nbsp;view&nbsp;is</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;set&nbsp;from&nbsp;the&nbsp;application&#39;s&nbsp;hardware&nbsp;acceleration&nbsp;setting.</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier java"><span>final</span></span><span>&nbsp;</span><span class="storage type java"><span>Context</span></span><span>&nbsp;context&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="variable other object java"><span>view</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>getContext</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>if</span></span><span>&nbsp;</span><span class="punctuation bracket round java"><span>(</span></span><span>context&nbsp;</span><span class="keyword operator comparison java"><span>!=</span></span><span>&nbsp;</span><span class="constant language java"><span>null</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword operator logical java"><span>&amp;&amp;</span></span><span>&nbsp;</span><span class="punctuation bracket round java"><span>(</span></span><span class="variable other object java"><span>context</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>getApplicationInfo</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>flags</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword operator bitwise java"><span>&amp;</span></span><span>&nbsp;</span><span class="variable other object java"><span>ApplicationInfo</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>FLAG_HARDWARE_ACCELERATED</span></span><span class="punctuation bracket round java"><span>)</span></span><span>&nbsp;</span><span class="keyword operator comparison java"><span>!=</span></span><span>&nbsp;</span><span class="constant numeric java"><span>0</span></span><span class="punctuation bracket round java"><span>)</span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>wparams</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>flags</span></span><span>&nbsp;</span><span class="keyword operator assignment bitwise java"><span>|=</span></span><span>&nbsp;</span><span class="variable other object java"><span>WindowManager</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other object property java"><span>LayoutParams</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>FLAG_HARDWARE_ACCELERATED</span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;</span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type java"><span>ViewRootImpl</span></span><span>&nbsp;root</span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type java"><span>View</span></span><span>&nbsp;panelParentView&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="constant language java"><span>null</span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span><span>.</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;ViewRootImpl是一个很重要的类,&nbsp;是ViewParent的子类,&nbsp;可以说是Window和WMS之间的桥梁,&nbsp;所有和View有关的Evnet,layout,draw,都在底层产生后通过WMS-&gt;ViewRootImpl传递给view</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;root&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="keyword control new java"><span>new</span></span><span>&nbsp;</span><span class="storage type java"><span>ViewRootImpl</span></span><span class="punctuation bracket round java"><span>(</span></span><span class="variable other object java"><span>view</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>getContext</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;display</span><span class="punctuation bracket round java"><span>)</span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;</span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>view</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>setLayoutParams</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span>wparams</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;</span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>mViews</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>add</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span>view</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>mRoots</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>add</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span>root</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>mParams</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>add</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span>wparams</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;</span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>root</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>setView</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span>view</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;wparams</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;panelParentView</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div></pre>
<p>在WindowManagerGlobal中, 会为每一个window创建对应的ViewRootImpl, 并把对应的 decorView, ViewRootImpl 和 WindowManager.LayoutParams 保存, 最后把decorView 通过android.view.ViewRootImpl#setView添加进WMS 妈蛋,好累啊, 终于快到WMS了</p>
<p>接着看一下android.view.ViewRootImpl#setView</p>
<pre class="editor-colors lang-java"><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="storage modifier java"><span>public</span></span><span>&nbsp;</span><span class="storage type primitive java"><span>void</span></span><span>&nbsp;</span><span class="meta function-call java"><span class="entity name function java"><span>setView</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="storage type java"><span>View</span></span><span>&nbsp;view</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="variable other object java"><span>WindowManager</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>LayoutParams</span></span><span>&nbsp;attrs</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="storage type java"><span>View</span></span><span>&nbsp;panelParentView</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;把Window对应的View保存下来,&nbsp;对应的其实就是&nbsp;PhoneWindow的&nbsp;mDecorView</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mView&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;view</span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;调用WMS后返回的结果</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type primitive java"><span>int</span></span><span>&nbsp;res</span><span class="punctuation terminator java"><span>;</span></span><span>&nbsp;</span><span class="comment block java"><span class="punctuation definition comment java"><span>/*</span></span><span>&nbsp;=&nbsp;WindowManagerImpl.ADD_OKAY;&nbsp;</span><span class="punctuation definition comment java"><span>*/</span></span></span></span></div><div class="line"><span class="source java"><span>&nbsp;</span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;Schedule&nbsp;the&nbsp;first&nbsp;layout&nbsp;-before-&nbsp;adding&nbsp;to&nbsp;the&nbsp;window</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;manager,&nbsp;to&nbsp;make&nbsp;sure&nbsp;we&nbsp;do&nbsp;the&nbsp;relayout&nbsp;before&nbsp;receiving</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;any&nbsp;other&nbsp;events&nbsp;from&nbsp;the&nbsp;system.</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;请求&nbsp;layout</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta function-call java"><span class="entity name function java"><span>requestLayout</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span><span>.</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;</span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;调用&nbsp;WMS添加window,&nbsp;并返回一个结果&nbsp;用于判定添加的结果</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="variable other object java"><span>mWindowSession</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>addToDisplay</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span>mWindow</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;mSeq</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;mWindowAttributes</span><span class="punctuation separator delimiter java"><span>,</span></span></span></span></div><div class="line"><span class="source java"><span class="meta method-call java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta function-call java"><span class="entity name function java"><span>getHostVisibility</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="variable other object java"><span>mDisplay</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>getDisplayId</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation separator delimiter java"><span>,</span></span></span></span></div><div class="line"><span class="source java"><span class="meta method-call java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>mAttachInfo</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>mContentInsets</span></span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="variable other object java"><span>mAttachInfo</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>mStableInsets</span></span><span class="punctuation separator delimiter java"><span>,</span></span></span></span></div><div class="line"><span class="source java"><span class="meta method-call java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>mAttachInfo</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>mOutsets</span></span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;mInputChannel</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span><span>.</span><span>.</span><span>.</span></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></div><div class="line"><span class="source java"><span>&nbsp;</span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;根据返回的结果&nbsp;判断是否添加成功,&nbsp;没成功&nbsp;就throw&nbsp;exception,&nbsp;经常看见的services打开dialog的异常&nbsp;就在这儿产生</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>if</span></span><span>&nbsp;</span><span class="punctuation bracket round java"><span>(</span></span><span>res&nbsp;</span><span class="keyword operator comparison java"><span>&lt;</span></span><span>&nbsp;</span><span class="variable other object java"><span>WindowManagerGlobal</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>ADD_OKAY</span></span><span class="punctuation bracket round java"><span>)</span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>mAttachInfo</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>mRootView</span></span><span>&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="constant language java"><span>null</span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mAdded&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="constant language java"><span>false</span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>mFallbackEventHandler</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>setView</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="constant language java"><span>null</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta function-call java"><span class="entity name function java"><span>unscheduleTraversals</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta function-call java"><span class="entity name function java"><span>setAccessibilityFocus</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="constant language java"><span>null</span></span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="constant language java"><span>null</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>switch</span></span><span>&nbsp;</span><span class="punctuation bracket round java"><span>(</span></span><span>res</span><span class="punctuation bracket round java"><span>)</span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>case</span></span><span>&nbsp;</span><span class="variable other object java"><span>WindowManagerGlobal</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>ADD_BAD_APP_TOKEN</span></span><span class="keyword control ternary java"><span>:</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>case</span></span><span>&nbsp;</span><span class="variable other object java"><span>WindowManagerGlobal</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>ADD_BAD_SUBWINDOW_TOKEN</span></span><span class="keyword control ternary java"><span>:</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control catch-exception java"><span>throw</span></span><span>&nbsp;</span><span class="keyword control new java"><span>new</span></span><span>&nbsp;</span><span class="storage type java"><span>WindowManager</span></span><span>.</span><span class="storage type java"><span>BadTokenException</span></span><span class="punctuation bracket round java"><span>(</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double java"><span class="punctuation definition string begin java"><span>&quot;</span></span><span>Unable&nbsp;to&nbsp;add&nbsp;window&nbsp;--&nbsp;token&nbsp;</span><span class="punctuation definition string end java"><span>&quot;</span></span></span><span>&nbsp;</span><span class="keyword operator arithmetic java"><span>+</span></span><span>&nbsp;</span><span class="variable other object java"><span>attrs</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>token</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword operator arithmetic java"><span>+</span></span><span>&nbsp;</span><span class="string quoted double java"><span class="punctuation definition string begin java"><span>&quot;</span></span><span>&nbsp;is&nbsp;not&nbsp;valid;&nbsp;is&nbsp;your&nbsp;activity&nbsp;running?</span><span class="punctuation definition string end java"><span>&quot;</span></span></span><span class="punctuation bracket round java"><span>)</span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>case</span></span><span>&nbsp;</span><span class="variable other object java"><span>WindowManagerGlobal</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>ADD_NOT_APP_TOKEN</span></span><span class="keyword control ternary java"><span>:</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control catch-exception java"><span>throw</span></span><span>&nbsp;</span><span class="keyword control new java"><span>new</span></span><span>&nbsp;</span><span class="storage type java"><span>WindowManager</span></span><span>.</span><span class="storage type java"><span>BadTokenException</span></span><span class="punctuation bracket round java"><span>(</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="string quoted double java"><span class="punctuation definition string begin java"><span>&quot;</span></span><span>Unable&nbsp;to&nbsp;add&nbsp;window&nbsp;--&nbsp;token&nbsp;</span><span class="punctuation definition string end java"><span>&quot;</span></span></span><span>&nbsp;</span><span class="keyword operator arithmetic java"><span>+</span></span><span>&nbsp;</span><span class="variable other object java"><span>attrs</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>token</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword operator arithmetic java"><span>+</span></span><span>&nbsp;</span><span class="string quoted double java"><span class="punctuation definition string begin java"><span>&quot;</span></span><span>&nbsp;is&nbsp;not&nbsp;for&nbsp;an&nbsp;application</span><span class="punctuation definition string end java"><span>&quot;</span></span></span><span class="punctuation bracket round java"><span>)</span></span><span class="punctuation terminator java"><span>;</span></span><span>&nbsp;&nbsp;&nbsp;</span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span><span>.</span><span>.</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span><span>.</span><span>.</span><span>.</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div></pre>
<p>ViewRootImpl里面, 首先会把window对应的decorView存一份, 然后通过mWindowSession向WMS发消息, mWindowSession是通过WindowManagerGlobal的静态方法获得, 前面说过,这玩意是一个单例, 在哪儿都可以拿到; android本身是一个CS架构, 调用WMS,需要先获取WMS对应的client, 而client端的获取,就是同 WindowManagerGlobal.initialize()进行, 连通WMS的服务端; android.view.WindowManagerGlobal#getWindowSession, 是通过getWindowManagerService().openSession()获得, 最后返回的是com.android.server.wm.Session, 而mWindowSession.addToDisplay最终调用的会是 com.android.server.wm.Session#addToDisplay, 最终会还是会调用com.android.server.wm.WindowManagerService#addWindow; 这一段在WMS Server端的代码也比较多, 就不贴代码了, 最后在WindowManagerService#addWindow, 会对WindowManager.LayoutParams做一些检验 并返回值, 下面会说到;</p>
<p>上面说过事件是通过WMS传递给ViewRootImpl,然后传递给View,Activity, 具体事件在ViewRootImpl的分发过程, 可以看这篇博客<a href="http://blog.csdn.net/singwhatiwanna/article/details/50775201">here</a></p>
<iframe id="embed_dom" name="embed_dom" frameborder="0" style="border:1px solid #000;display:block;width:430px; height:320px;" src="https://www.processon.com/embed/57e1209ce4b0a16a66fe833d"></iframe>

<h1 id="dialog-window-">dialog的Window创建过程</h1>
<p>1.dialog的窗口创建显示过程,其实与activity相似, 最后对应的Window其实也是PhoneWindow 首先直接看Dialog的构造方法</p>
<pre class="editor-colors lang-java"><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta function-call java"><span class="entity name function java"><span>Dialog</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="storage type annotation java"><span>@NonNull</span></span><span>&nbsp;</span><span class="storage type java"><span>Context</span></span><span>&nbsp;context</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="storage type annotation java"><span>@StyleRes</span></span><span>&nbsp;</span><span class="storage type primitive java"><span>int</span></span><span>&nbsp;themeResId</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="storage type primitive java"><span>boolean</span></span><span>&nbsp;createContextThemeWrapper</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span><span>.</span><span>.</span><span>.</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;用getSystemService获取&nbsp;WindowManger实例</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mWindowManager&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="punctuation bracket round java"><span>(</span></span><span class="storage type java"><span>WindowManager</span></span><span class="punctuation bracket round java"><span>)</span></span><span>&nbsp;</span><span class="variable other object java"><span>context</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>getSystemService</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="variable other object java"><span>Context</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>WINDOW_SERVICE</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;直接创建一个&nbsp;PhoneWindow的实例</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier java"><span>final</span></span><span>&nbsp;</span><span class="storage type java"><span>Window</span></span><span>&nbsp;w&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="keyword control new java"><span>new</span></span><span>&nbsp;</span><span class="storage type java"><span>PhoneWindow</span></span><span class="punctuation bracket round java"><span>(</span></span><span>mContext</span><span class="punctuation bracket round java"><span>)</span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mWindow&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;w</span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>w</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>setCallback</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="variable language this java"><span>this</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>w</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>setOnWindowDismissedCallback</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="variable language this java"><span>this</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>w</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>setWindowManager</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span>mWindowManager</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="constant language java"><span>null</span></span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="constant language java"><span>null</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>w</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>setGravity</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="variable other object java"><span>Gravity</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>CENTER</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mListenersHandler&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="keyword control new java"><span>new</span></span><span>&nbsp;</span><span class="storage type java"><span>ListenersHandler</span></span><span class="punctuation bracket round java"><span>(</span></span><span class="variable language this java"><span>this</span></span><span class="punctuation bracket round java"><span>)</span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div></pre>
<p>代码很明显, 首先获取windowManager实例, 然后创建window对象,然后在设置callback,对PhoneWindow的实例设置WindowManager;(这里有一点和Activity不同, Activity是调用Window的setWindowManager后, 把Window对应的WindowManger获取,然后赋值给自己的变量Activity#mWindowManger, 而dialog没这个操作; dialog对应的Window对象,就只是传入的Context实例去getSystemService所得); 接下来,就是设置dialog的view,和Activity一样,都是调用setContentView, 看下代码</p>
<pre class="editor-colors lang-java"><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="storage modifier java"><span>public</span></span><span>&nbsp;</span><span class="storage type primitive java"><span>void</span></span><span>&nbsp;</span><span class="meta function-call java"><span class="entity name function java"><span>setContentView</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="storage type annotation java"><span>@LayoutRes</span></span><span>&nbsp;</span><span class="storage type primitive java"><span>int</span></span><span>&nbsp;layoutResID</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>mWindow</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>setContentView</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span>layoutResID</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div></pre>
<p>代码很简单,直接调用的<code>mWindow.setContentView</code>, 把对应的视图,添加到PhoneWindow的DecorView中去; 接下来就是显示了, 看一下Dialog#show方法</p>
<pre class="editor-colors lang-java"><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier java"><span>public</span></span><span>&nbsp;</span><span class="storage type primitive java"><span>void</span></span><span>&nbsp;</span><span class="meta function-call java"><span class="entity name function java"><span>show</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;调用Dialog#onCreate方法,&nbsp;通常也是在onCreate方法中,改变Window.LayoutParams,&nbsp;从而调整dialog的宽高,&nbsp;动画,&nbsp;显示位置</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="meta function-call java"><span class="entity name function java"><span>onStart</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span><span>.</span><span>.</span><span>.</span><span>.</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mDecor&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="variable other object java"><span>mWindow</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>getDecorView</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>WindowManager</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>LayoutParams</span></span><span>&nbsp;l&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="variable other object java"><span>mWindow</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>getAttributes</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;调用WindowManager去显示</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>mWindowManager</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>addView</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span>mDecor</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;l</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mShowing&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="constant language java"><span>true</span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;</span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div></pre>
<p>显示的代码逻辑,和Activity显示的一样, 就是调用WindowManger#addView方法 在这儿就有一个开发中常遇到的问题, Activity可以直接调用show()显示一个dialog, 而Service调用会报错,解决这个问题也很简单,一般就是声明使用系统Window的权限, 然后在设置dialog的type, dialog.getWindow().setType(LayoutParams.TYPE_SYSTEM_ERROR)<br>
一般错误如下<br>
<img src="http://obh9ec69s.bkt.clouddn.com/Application_dialog_error.png" alt=""></p>
<p>那产生这种情况,具体原因是什么呢?<br>
首先说下结论,产生这个情况是因为WindowManger实例的缘故;我们看代码,分析具体的原因,首先肯定传入的Context对象不同,而context的不同,会影响什么呢, 在上面dialog创建过程中说过, dialog中的WindowMange对象, 是Context#getSystemService获得, 在Activity获取WindowManger时候,我提到过Activity重写了getSystemService方法, 看一下Activity#getSystemService的代码</p>
<pre class="editor-colors lang-java"><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type annotation java"><span>@Override</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage modifier java"><span>public</span></span><span>&nbsp;</span><span class="storage type java"><span>Object</span></span><span>&nbsp;</span><span class="meta function-call java"><span class="entity name function java"><span>getSystemService</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="storage type annotation java"><span>@ServiceName</span></span><span>&nbsp;</span><span class="storage type annotation java"><span>@NonNull</span></span><span>&nbsp;</span><span class="storage type java"><span>String</span></span><span>&nbsp;name</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;获取WMS时,&nbsp;直接返回自身的windowManger</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>if</span></span><span>&nbsp;</span><span class="punctuation bracket round java"><span>(</span></span><span class="variable other object java"><span>WINDOW_SERVICE</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>equals</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span>name</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation bracket round java"><span>)</span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>return</span></span><span>&nbsp;mWindowManager</span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>return</span></span><span>&nbsp;</span><span class="variable language java"><span>super</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>getSystemService</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span>name</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div></pre>
<p>在传入的Context是Activity实例时, 获取到的WindowManger, 就是Activity自身的mWindowManager,而其他的context对象,获取的都是默认的WindowManger; 这2个WindowManger实例有什么不同呢, 上面也说到过,Activity的WindowManger创建过程中, 把其对应的PhoneWindow实例传给了WindowManager#mParentView, 最后在调用WindowManagerGlobal#addView时, 会调用<code>parentWindow.adjustLayoutParamsForSubWindow(wparams)</code>, 从而调整了LayoutParams, 设置了window的token;</p>
<p>下一个问题,调用dialog.getWindow().setType(LayoutParams.TYPE_SYSTEM_ERROR)为啥就不报错了呢?<br>
首先,看一下这个错误在哪儿抛出来的, 在上面的Activity的window显示流程中,说道window创建过程,最后会调用android.view.ViewRootImpl#setView, 这个方法中, 会调用WMS服务端, 并且返回一个值, 根据返回值,确定WMS服务端是否添加成功, 如果返回值不是<code>WindowManagerGlobal.ADD_OKAY</code>, 就抛出的异常, 其中有一个异常就是;<br>
接着在看WMS服务端,什么时候会返回这个, 看一下<code>com.android.server.wm.WindowManagerService#addWindow</code></p>
<pre class="editor-colors lang-java"><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>com.android.server.wm.WindowManagerService#addWindow</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="storage modifier java"><span>public</span></span><span>&nbsp;</span><span class="storage type primitive java"><span>int</span></span><span>&nbsp;</span><span class="meta function-call java"><span class="entity name function java"><span>addWindow</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="storage type java"><span>Session</span></span><span>&nbsp;session</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="storage type java"><span>IWindow</span></span><span>&nbsp;client</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="storage type primitive java"><span>int</span></span><span>&nbsp;seq</span><span class="punctuation separator delimiter java"><span>,</span></span></span></span></div><div class="line"><span class="source java"><span class="meta function-call java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>WindowManager</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>LayoutParams</span></span><span>&nbsp;attrs</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="storage type primitive java"><span>int</span></span><span>&nbsp;viewVisibility</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="storage type primitive java"><span>int</span></span><span>&nbsp;displayId</span><span class="punctuation separator delimiter java"><span>,</span></span></span></span></div><div class="line"><span class="source java"><span class="meta function-call java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type java"><span>Rect</span></span><span>&nbsp;outContentInsets</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="storage type java"><span>Rect</span></span><span>&nbsp;outStableInsets</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="storage type java"><span>Rect</span></span><span>&nbsp;outOutsets</span><span class="punctuation separator delimiter java"><span>,</span></span></span></span></div><div class="line"><span class="source java"><span class="meta function-call java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type java"><span>InputChannel</span></span><span>&nbsp;outInputChannel</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;检查权限,&nbsp;mPolicy是&nbsp;com.android.server.policy.PhoneWindowManager&nbsp;的实例</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type primitive java"><span>int</span></span><span>&nbsp;res&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="variable other object java"><span>mPolicy</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>checkAddPermission</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span>attrs</span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;appOp</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>if</span></span><span>&nbsp;</span><span class="punctuation bracket round java"><span>(</span></span><span>res&nbsp;</span><span class="keyword operator comparison java"><span>!=</span></span><span>&nbsp;</span><span class="variable other object java"><span>WindowManagerGlobal</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>ADD_OKAY</span></span><span class="punctuation bracket round java"><span>)</span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>return</span></span><span>&nbsp;res</span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;token为null时,&nbsp;对type进行判断</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type java"><span>WindowToken</span></span><span>&nbsp;token&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="variable other object java"><span>mTokenMap</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>get</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="variable other object java"><span>attrs</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>token</span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>if</span></span><span>&nbsp;</span><span class="punctuation bracket round java"><span>(</span></span><span>token&nbsp;</span><span class="keyword operator comparison java"><span>==</span></span><span>&nbsp;</span><span class="constant language java"><span>null</span></span><span class="punctuation bracket round java"><span>)</span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>if</span></span><span>&nbsp;</span><span class="punctuation bracket round java"><span>(</span></span><span>type&nbsp;</span><span class="keyword operator comparison java"><span>&gt;=</span></span><span>&nbsp;</span><span class="storage type java"><span>FIRST_APPLICATION_WINDOW</span></span><span>&nbsp;</span><span class="keyword operator logical java"><span>&amp;&amp;</span></span><span>&nbsp;type&nbsp;</span><span class="keyword operator comparison java"><span>&lt;=</span></span><span>&nbsp;</span><span class="storage type java"><span>LAST_APPLICATION_WINDOW</span></span><span class="punctuation bracket round java"><span>)</span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="variable other object java"><span>Slog</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>w</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span class="storage type java"><span>TAG</span></span><span class="punctuation separator delimiter java"><span>,</span></span><span>&nbsp;</span><span class="string quoted double java"><span class="punctuation definition string begin java"><span>&quot;</span></span><span>Attempted&nbsp;to&nbsp;add&nbsp;application&nbsp;window&nbsp;with&nbsp;unknown&nbsp;token&nbsp;</span><span class="punctuation definition string end java"><span>&quot;</span></span></span></span></span></div><div class="line"><span class="source java"><span class="meta method-call java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword operator arithmetic java"><span>+</span></span><span>&nbsp;</span><span class="variable other object java"><span>attrs</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>token</span></span><span>&nbsp;</span><span class="keyword operator arithmetic java"><span>+</span></span><span>&nbsp;</span><span class="string quoted double java"><span class="punctuation definition string begin java"><span>&quot;</span></span><span>.&nbsp;&nbsp;Aborting.</span><span class="punctuation definition string end java"><span>&quot;</span></span></span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>return</span></span><span>&nbsp;</span><span class="variable other object java"><span>WindowManagerGlobal</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>ADD_BAD_APP_TOKEN</span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span><span>.</span><span>.</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;</span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>com.android.server.policy.PhoneWindowManager#checkAddPermission</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="variable other object java"><span>com</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other object property java"><span>android</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other object property java"><span>server</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other object property java"><span>policy</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>PhoneWindowManager</span></span><span>#checkAddPermission</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type primitive java"><span>int</span></span><span>&nbsp;type&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="variable other object java"><span>attrs</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>type</span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span><span>.</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;根据类型&nbsp;判断权限</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="storage type java"><span>String</span></span><span>&nbsp;permission&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="constant language java"><span>null</span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>switch</span></span><span>&nbsp;</span><span class="punctuation bracket round java"><span>(</span></span><span>type</span><span class="punctuation bracket round java"><span>)</span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>case</span></span><span>&nbsp;</span><span class="storage type java"><span>TYPE_TOAST</span></span><span class="keyword control ternary java"><span>:</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;</span><span class="storage type class xxx"><span>XXX</span></span><span>&nbsp;right&nbsp;now&nbsp;the&nbsp;app&nbsp;process&nbsp;has&nbsp;complete&nbsp;control&nbsp;over</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;this...&nbsp;&nbsp;should&nbsp;introduce&nbsp;a&nbsp;token&nbsp;to&nbsp;let&nbsp;the&nbsp;system</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;monitor/control&nbsp;what&nbsp;they&nbsp;are&nbsp;doing.</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;outAppOp</span><span class="punctuation bracket square java"><span>[</span></span><span class="constant numeric java"><span>0</span></span><span class="punctuation bracket square java"><span>]</span></span><span>&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="variable other object java"><span>AppOpsManager</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>OP_TOAST_WINDOW</span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>break</span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>case</span></span><span>&nbsp;</span><span class="storage type java"><span>TYPE_DREAM</span></span><span class="keyword control ternary java"><span>:</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>case</span></span><span>&nbsp;</span><span class="storage type java"><span>TYPE_INPUT_METHOD</span></span><span class="keyword control ternary java"><span>:</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>case</span></span><span>&nbsp;</span><span class="storage type java"><span>TYPE_WALLPAPER</span></span><span class="keyword control ternary java"><span>:</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>case</span></span><span>&nbsp;</span><span class="storage type java"><span>TYPE_PRIVATE_PRESENTATION</span></span><span class="keyword control ternary java"><span>:</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>case</span></span><span>&nbsp;</span><span class="storage type java"><span>TYPE_VOICE_INTERACTION</span></span><span class="keyword control ternary java"><span>:</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>case</span></span><span>&nbsp;</span><span class="storage type java"><span>TYPE_ACCESSIBILITY_OVERLAY</span></span><span class="keyword control ternary java"><span>:</span></span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>&nbsp;The&nbsp;window&nbsp;manager&nbsp;will&nbsp;check&nbsp;these.</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>break</span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>case</span></span><span>&nbsp;</span><span class="storage type java"><span>TYPE_PHONE</span></span><span class="keyword control ternary java"><span>:</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>case</span></span><span>&nbsp;</span><span class="storage type java"><span>TYPE_PRIORITY_PHONE</span></span><span class="keyword control ternary java"><span>:</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>case</span></span><span>&nbsp;</span><span class="storage type java"><span>TYPE_SYSTEM_ALERT</span></span><span class="keyword control ternary java"><span>:</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>case</span></span><span>&nbsp;</span><span class="storage type java"><span>TYPE_SYSTEM_ERROR</span></span><span class="keyword control ternary java"><span>:</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>case</span></span><span>&nbsp;</span><span class="storage type java"><span>TYPE_SYSTEM_OVERLAY</span></span><span class="keyword control ternary java"><span>:</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;permission&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="variable other object java"><span>android</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other object property java"><span>Manifest</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other object property java"><span>permission</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>SYSTEM_ALERT_WINDOW</span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;outAppOp</span><span class="punctuation bracket square java"><span>[</span></span><span class="constant numeric java"><span>0</span></span><span class="punctuation bracket square java"><span>]</span></span><span>&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="variable other object java"><span>AppOpsManager</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>OP_SYSTEM_ALERT_WINDOW</span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>break</span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>default</span></span><span class="keyword control ternary java"><span>:</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;permission&nbsp;</span><span class="keyword operator assignment java"><span>=</span></span><span>&nbsp;</span><span class="variable other object java"><span>android</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other object property java"><span>Manifest</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other object property java"><span>permission</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>INTERNAL_SYSTEM_WINDOW</span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span><span>.</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;</span></span></div><div class="line"><span class="source java"><span class="punctuation whitespace comment leading java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></span><span class="comment line double-slash java"><span class="punctuation definition comment java"><span>//</span></span><span>权限不够&nbsp;&nbsp;也返回错误代码</span><span>&nbsp;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>if</span></span><span>&nbsp;</span><span class="punctuation bracket round java"><span>(</span></span><span class="variable other object java"><span>mContext</span></span><span class="meta method-call java"><span class="punctuation separator period java"><span>.</span></span><span class="entity name function java"><span>checkCallingOrSelfPermission</span></span><span class="punctuation definition parameters begin bracket round java"><span>(</span></span><span>permission</span><span class="punctuation definition parameters end bracket round java"><span>)</span></span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword operator comparison java"><span>!=</span></span><span>&nbsp;</span><span class="variable other object java"><span>PackageManager</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>PERMISSION_GRANTED</span></span><span class="punctuation bracket round java"><span>)</span></span><span>&nbsp;</span><span class="punctuation section block begin bracket curly java"><span>{</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="keyword control java"><span>return</span></span><span>&nbsp;</span><span class="variable other object java"><span>WindowManagerGlobal</span></span><span class="punctuation separator period java"><span>.</span></span><span class="variable other property java"><span>ADD_PERMISSION_DENIED</span></span><span class="punctuation terminator java"><span>;</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="punctuation separator period java"><span>.</span><span>.</span><span>.</span></span></span></div><div class="line"><span class="source java"><span>&nbsp;&nbsp;</span><span class="punctuation section block end bracket curly java"><span>}</span></span></span></div></pre>
<p>上面代码可以看见, 首先回去检测权限, 如果是type系统的window, 则需要权限, 如果没有权限, 最后一样会抛出异常<br>
当token为null时, 会去检查type, 如果type和对, 也会抛异常;<br>
而Activity可以显示dialog, 上面的代码已经分析了, 是对dialog的windowLayoutParams设置了token, 从而通过检测</p>
<p>上面说了, 设置系统弹窗, 需要声明权限, 没有权限也会失败,在国内各种rom的手机上, 系统弹窗的权限,有可能会被默认禁止掉, 有没有 <em><strong>不用系统弹窗权限, 而显示系统弹窗</strong></em> 的呢 其实也是可以的,可以设置弹窗的类型是Toast(其实toast也是一个window,下面再说), 从而规避这个, 具体的分析可以看下面2篇博客 有些手机上弹框需要权限,通过<code>TYPE_TOAST</code>突破权限的分析 <a href="http://www.jianshu.com/p/167fd5f47d5c/comments/776666">here</a>, 和<a href="http://www.liaohuqiu.net/cn/posts/android-windows-manager/">here</a></p>
<hr>
<p>还有PopupWindow 和Toast的window, 以后在写吧 - -</p></body>
</html>
